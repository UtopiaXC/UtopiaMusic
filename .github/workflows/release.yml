name: Release
run-name: Release ${{ github.ref_name }} by @${{ github.actor }}
on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  FLUTTER_CHANNEL: "stable"

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      VERSION_NAME: ${{ steps.version_computation.outputs.version_name }}
      BUILD_NUMBER: ${{ steps.version_computation.outputs.build_number }}
      RELEASE_NOTE_PATH: ${{ steps.release_note_finder.outputs.note_path }}
    steps:
      - uses: actions/checkout@v4
      - name: Compute version from tag
        id: version_computation
        shell: bash
        run: |
          tagName=${{ github.ref_name }}
          cleanVersion=${tagName#v}
          cleanVersion=${cleanVersion%+*}
          
          echo "version_name=$cleanVersion" >> "$GITHUB_OUTPUT"
          echo "build_number=${{ github.run_number }}" >> "$GITHUB_OUTPUT"

      - name: Find release note file
        id: release_note_finder
        shell: bash
        run: |
          tagName=${{ github.ref_name }}
          cleanVersion=${tagName#v}
          cleanVersion=${cleanVersion%+*}
          
          notePathWithV="assets/documentations/release_note/${tagName}.md"
          notePathWithoutV="assets/documentations/release_note/${cleanVersion}.md"
          
          if [ -f "$notePathWithV" ]; then
            echo "note_path=$notePathWithV" >> "$GITHUB_OUTPUT"
          elif [ -f "$notePathWithoutV" ]; then
            echo "note_path=$notePathWithoutV" >> "$GITHUB_OUTPUT"
          else
            touch release_note_empty.md
            echo "note_path=release_note_empty.md" >> "$GITHUB_OUTPUT"
          fi

  android:
    needs: version
    runs-on: ubuntu-latest
    env:
      VERSION_NAME: ${{ needs.version.outputs.VERSION_NAME }}
      BUILD_NUMBER: ${{ needs.version.outputs.BUILD_NUMBER }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
      - uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ~/.gradle
            ~/.android
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
      - name: Flutter pub get
        run: flutter pub get
      - name: Decode Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks

      - name: Build split-per-abi APKs
        env:
          ANDROID_KEYSTORE_PATH: "upload-keystore.jks"
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: flutter build apk --release --split-per-abi --build-name $VERSION_NAME --build-number $BUILD_NUMBER

      - name: Rename and Collect APKs
        run: |
          mkdir -p out
          for apk in build/app/outputs/flutter-apk/*-release.apk; do
            abi=$(basename "$apk" | sed 's/.*-\(.*\)-release\.apk/\1/')
            cp "$apk" "out/UtopiaMusic-${VERSION_NAME}-Android-${abi}.apk"
          done
      - uses: actions/upload-artifact@v4
        with:
          name: android
          path: out/*.apk
          if-no-files-found: error

  linux:
    needs: version
    runs-on: ubuntu-latest
    env:
      VERSION_NAME: ${{ needs.version.outputs.VERSION_NAME }}
      BUILD_NUMBER: ${{ needs.version.outputs.BUILD_NUMBER }}
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
      - uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libglib2.0-dev patchelf ruby-dev rubygems rpm
          sudo gem install --no-document fpm
          wget -q https://github.com/AppImage/appimagetool/releases/download/1.9.1/appimagetool-x86_64.AppImage -O appimagetool
          chmod +x appimagetool
      - name: Flutter pub get
        run: flutter pub get
      - name: Build linux bundle
        run: flutter build linux --release --build-name $VERSION_NAME --build-number $BUILD_NUMBER
      - name: Package AppImage deb rpm
        run: |
          mkdir -p dist/AppDir/usr/bin dist/AppDir/usr/share/applications dist/AppDir/usr/share/icons/hicolor/256x256/apps
          cp -r build/linux/x64/release/bundle/* dist/AppDir/usr/bin/
          
          cat > dist/AppDir/utopiamusic.desktop <<'EOF'
          [Desktop Entry]
          Type=Application
          Name=UtopiaMusic
          Exec=UtopiaMusic
          Icon=utopiamusic
          Categories=Audio;Music;
          EOF
          
          cp dist/AppDir/utopiamusic.desktop dist/AppDir/usr/share/applications/
          
          if [ -f assets/images/ic_windows.png ]; then 
            cp assets/images/ic_windows.png dist/AppDir/utopiamusic.png
            cp assets/images/ic_windows.png dist/AppDir/usr/share/icons/hicolor/256x256/apps/utopiamusic.png
          fi
          
          ln -s usr/bin/UtopiaMusic dist/AppDir/AppRun
          
          (cd dist && ARCH=x86_64 ../appimagetool AppDir "UtopiaMusic-${VERSION_NAME}-Linux-x64.AppImage")
          
          debVersion=${VERSION_NAME/+/-}
          fpm -s dir -t deb -n utopiamusic -v "$debVersion" --architecture amd64 --prefix /opt/utopiamusic -C build/linux/x64/release/bundle .
          mv utopiamusic_${debVersion}_amd64.deb "dist/UtopiaMusic-${VERSION_NAME}-Linux-x64.deb"
          rpmVersion=${VERSION_NAME/+/.}
          fpm -s dir -t rpm -n utopiamusic -v "$rpmVersion" --architecture x86_64 --prefix /opt/utopiamusic -C build/linux/x64/release/bundle .
          mv utopiamusic-${rpmVersion}-1.x86_64.rpm "dist/UtopiaMusic-${VERSION_NAME}-Linux-x64.rpm"
      - uses: actions/upload-artifact@v4
        with:
          name: linux
          path: |
            dist/UtopiaMusic-${{ env.VERSION_NAME }}-Linux-x64.AppImage
            dist/UtopiaMusic-${{ env.VERSION_NAME }}-Linux-x64.deb
            dist/UtopiaMusic-${{ env.VERSION_NAME }}-Linux-x64.rpm
          if-no-files-found: error

  apple:
    needs: version
    runs-on: macos-latest
    env:
      VERSION_NAME: ${{ needs.version.outputs.VERSION_NAME }}
      BUILD_NUMBER: ${{ needs.version.outputs.BUILD_NUMBER }}
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
      - name: Flutter pub get
        run: flutter pub get
      - name: Build iOS unsigned
        run: flutter build ios --release --no-codesign --build-name $VERSION_NAME --build-number $BUILD_NUMBER
      - name: Optimize iOS Frameworks
        run: |
          APP_PATH="build/ios/Release-iphoneos/Runner.app"
          find "$APP_PATH/Frameworks" -type d -name '*.framework' | while read -r framework_path
          do
              name=$(basename "$framework_path" .framework)
              binary="$framework_path/$name"
              if lipo -info "$binary" | grep -q "x86_64"; then
                  echo "Stripping x86_64 from $name"
                  lipo -remove x86_64 "$binary" -o "$binary"
              fi
              echo "Re-signing $name with ad-hoc signature"
              codesign --force --sign - "$binary"
          done
      - name: Create unsigned IPA
        run: |
          mkdir -p dist/ios/Payload
          cp -R build/ios/Release-iphoneos/Runner.app dist/ios/Payload/Runner.app
          (cd dist/ios && zip -r "UtopiaMusic-${VERSION_NAME}-iOS-universal.ipa" Payload)
      - name: Build macOS app
        run: flutter build macos --release --build-name $VERSION_NAME --build-number $BUILD_NUMBER
      - name: Ad-hoc Sign macOS App
        run: |
          appPath=$(find build/macos/Build/Products/Release -maxdepth 1 -name "*.app" | head -n1)
          codesign --force --deep --sign - "$appPath"
      - name: Create DMG
        run: |
          mkdir -p dist/mac
          applicationPath=$(find build/macos/Build/Products/Release -maxdepth 1 -name "*.app" | head -n1)
          if [ -z "$applicationPath" ]; then
            exit 1
          fi
          hdiutil create -volname "UtopiaMusic" -srcfolder "$applicationPath" -ov -format UDZO "dist/mac/UtopiaMusic-${VERSION_NAME}-macOS-universal.dmg"
      - uses: actions/upload-artifact@v4
        with:
          name: apple
          path: |
            dist/ios/UtopiaMusic-${{ env.VERSION_NAME }}-iOS-universal.ipa
            dist/mac/UtopiaMusic-${{ env.VERSION_NAME }}-macOS-universal.dmg
          if-no-files-found: error

  windows:
    needs: version
    runs-on: windows-latest
    env:
      VERSION_NAME: ${{ needs.version.outputs.VERSION_NAME }}
      BUILD_NUMBER: ${{ needs.version.outputs.BUILD_NUMBER }}
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
      - name: Decode PFX Certificate
        run: |
          $pfx_cert_byte = [System.Convert]::FromBase64String("${{ secrets.WINDOWS_PFX_BASE64 }}")
          [IO.File]::WriteAllBytes("cert.pfx", $pfx_cert_byte)
      - name: Flutter pub get
        run: flutter pub get
      - name: Build Windows
        run: flutter build windows --release --build-name $env:VERSION_NAME --build-number $env:BUILD_NUMBER
      - name: Sign Main Executable
        run: |
          $signtool = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits" -Filter signtool.exe -Recurse | Sort-Object FullName -Descending | Select-Object -First 1
          & $signtool.FullName sign /f cert.pfx /p "${{ secrets.WINDOWS_PFX_PASSWORD }}" /tr http://timestamp.digicert.com /td sha256 /fd sha256 "build\windows\x64\runner\Release\*.exe"
      - name: Package portable zip
        run: |
          New-Item -ItemType Directory -Force -Path out | Out-Null
          Compress-Archive -Path build\windows\x64\runner\Release\* -DestinationPath "out\UtopiaMusic-${env:VERSION_NAME}-Windows-x64-portable.zip"
      - name: Package setup exe
        run: |
          if (Test-Path "windows\installer.iss") {
            choco install innosetup -y
            iscc "windows\installer.iss" /DAppVersion=${env:VERSION_NAME} /O"out" /F"UtopiaMusic-${env:VERSION_NAME}-Windows-x64-setup"
            $signtool = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits" -Filter signtool.exe -Recurse | Sort-Object FullName -Descending | Select-Object -First 1
            & $signtool.FullName sign /f cert.pfx /p "${{ secrets.WINDOWS_PFX_PASSWORD }}" /tr http://timestamp.digicert.com /td sha256 /fd sha256 "out\UtopiaMusic-${env:VERSION_NAME}-Windows-x64-setup.exe"
          }
      - uses: actions/upload-artifact@v4
        with:
          name: windows
          path: out/*
          if-no-files-found: error

  publish:
    needs: [ version, android, linux, apple, windows ]
    runs-on: ubuntu-latest
    env:
      VERSION_NAME: ${{ needs.version.outputs.VERSION_NAME }}
      RELEASE_NOTE_PATH: ${{ needs.version.outputs.RELEASE_NOTE_PATH }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true
      - run: ls -R artifacts
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: artifacts/**/*
          draft: false
          prerelease: false
          body_path: ${{ env.RELEASE_NOTE_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}