name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  FLUTTER_CHANNEL: "stable"

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      BUILD_NAME: ${{ steps.version.outputs.build_name }}
      BUILD_NUMBER: ${{ steps.version.outputs.build_number }}
    steps:
      - uses: actions/checkout@v4
      - name: Compute Version
        id: version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag_name="${{ github.ref_name }}"
          build_name="${tag_name#v}"
          today=$(TZ=Asia/Tokyo date +%Y%m%d)
          count=$(gh release list --limit 100 --json createdAt --jq "[.[] | select(.createdAt | startswith(\"${today}\"))] | length")
          seq=$((count + 1))
          build_number=$(printf "%s%02d" "$today" "$seq")
          echo "build_name=$build_name" >> "$GITHUB_OUTPUT"
          echo "build_number=$build_number" >> "$GITHUB_OUTPUT"

  android:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
      - run: flutter pub get
      - name: Build APK
        run: flutter build apk --release --split-per-abi --build-name ${{ needs.prepare.outputs.BUILD_NAME }} --build-number ${{ needs.prepare.outputs.BUILD_NUMBER }}
      - name: Rename Artifacts
        env:
          VERSION: ${{ needs.prepare.outputs.BUILD_NAME }}
        run: |
          mkdir dist
          for apk in build/app/outputs/flutter-apk/*-release.apk; do
            abi=$(basename "$apk" | sed 's/.*-\(.*\)-release\.apk/\1/')
            cp "$apk" "dist/UtopiaMusic-${VERSION}-Android-${abi}.apk"
          done
      - uses: actions/upload-artifact@v4
        with:
          name: android
          path: dist/*.apk

  linux:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libglib2.0-dev patchelf ruby-dev rubygems rpm
          sudo gem install --no-document fpm
          wget -q https://github.com/AppImage/appimagetool/releases/download/1.9.1/appimagetool-x86_64.AppImage -O appimagetool
          chmod +x appimagetool
      - run: flutter pub get
      - name: Build Linux
        run: flutter build linux --release --build-name ${{ needs.prepare.outputs.BUILD_NAME }} --build-number ${{ needs.prepare.outputs.BUILD_NUMBER }}
      - name: Package
        env:
          VERSION: ${{ needs.prepare.outputs.BUILD_NAME }}
        run: |
          mkdir -p dist/AppDir/usr/bin dist/AppDir/usr/share/applications dist/AppDir/usr/share/icons/hicolor/256x256/apps
          cp -r build/linux/x64/release/bundle/* dist/AppDir/usr/bin/
          
          cat > dist/AppDir/utopiamusic.desktop <<'EOF'
          [Desktop Entry]
          Type=Application
          Name=UtopiaMusic
          Exec=UtopiaMusic
          Icon=utopiamusic
          Categories=Audio;Music;
          EOF
          cp dist/AppDir/utopiamusic.desktop dist/AppDir/usr/share/applications/
          
          if [ -f assets/images/ic_windows.png ]; then 
            cp assets/images/ic_windows.png dist/AppDir/utopiamusic.png
            cp assets/images/ic_windows.png dist/AppDir/usr/share/icons/hicolor/256x256/apps/utopiamusic.png
          fi
          
          ln -s usr/bin/UtopiaMusic dist/AppDir/AppRun
          (cd dist && ARCH=x86_64 ../appimagetool AppDir "UtopiaMusic-${VERSION}-Linux-x64.AppImage")
          fpm -s dir -t deb -n utopiamusic -v "${VERSION}" --architecture amd64 --prefix /opt/utopiamusic -C build/linux/x64/release/bundle .
          mv utopiamusic_${VERSION}_amd64.deb "dist/UtopiaMusic-${VERSION}-Linux-x64.deb"
          fpm -s dir -t rpm -n utopiamusic -v "${VERSION}" --architecture x86_64 --prefix /opt/utopiamusic -C build/linux/x64/release/bundle .
          mv utopiamusic-${VERSION}-1.x86_64.rpm "dist/UtopiaMusic-${VERSION}-Linux-x64.rpm"
      - uses: actions/upload-artifact@v4
        with:
          name: linux
          path: dist/*.*

  apple:
    needs: prepare
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
      - run: flutter pub get

      - name: Build iOS
        run: flutter build ios --release --no-codesign --build-name ${{ needs.prepare.outputs.BUILD_NAME }} --build-number ${{ needs.prepare.outputs.BUILD_NUMBER }}
      - name: Package IPA
        env:
          VERSION: ${{ needs.prepare.outputs.BUILD_NAME }}
        run: |
          mkdir -p dist/ios/Payload
          cp -R build/ios/Release-iphoneos/Runner.app dist/ios/Payload/Runner.app
          cd dist/ios
          zip -r "UtopiaMusic-${VERSION}-iOS.ipa" Payload

      - name: Build macOS
        run: flutter build macos --release --build-name ${{ needs.prepare.outputs.BUILD_NAME }} --build-number ${{ needs.prepare.outputs.BUILD_NUMBER }}
      - name: Package DMG
        env:
          VERSION: ${{ needs.prepare.outputs.BUILD_NAME }}
        run: |
          mkdir -p dist/mac
          APP_PATH=$(find build/macos/Build/Products/Release -maxdepth 1 -name "*.app" | head -n1)
          hdiutil create -volname "UtopiaMusic" -srcfolder "$APP_PATH" -ov -format UDZO "dist/mac/UtopiaMusic-${VERSION}-macOS-universal.dmg"

      - uses: actions/upload-artifact@v4
        with:
          name: apple
          path: |
            dist/ios/*.ipa
            dist/mac/*.dmg

  windows:
    needs: prepare
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
      - run: flutter pub get
      - name: Build Windows
        run: flutter build windows --release --build-name ${{ needs.prepare.outputs.BUILD_NAME }} --build-number ${{ needs.prepare.outputs.BUILD_NUMBER }}
      - name: Package
        env:
          VERSION: ${{ needs.prepare.outputs.BUILD_NAME }}
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Compress-Archive -Path build\windows\x64\runner\Release\* -DestinationPath "dist\UtopiaMusic-${env:VERSION}-Windows-x64-portable.zip"
          
          # Setup: UtopiaMusic-1.0.0-Windows-x64-setup.exe
          if (Test-Path "windows\installer.iss") {
            choco install innosetup -y
            iscc "windows\installer.iss" /DAppVersion=${env:VERSION} /O"dist" /F"UtopiaMusic-${env:VERSION}-Windows-x64-setup"
          }
      - uses: actions/upload-artifact@v4
        with:
          name: windows
          path: dist/*

  publish:
    needs: [prepare, android, linux, apple, windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Prepare Release Note
        id: note
        run: |
          tag_name="${{ github.ref_name }}"
          note_file="assets/documentations/release_note/${tag_name}.md"
          
          if [ -f "$note_file" ]; then
            cat "$note_file" > release_body.md
          else
            touch release_body.md
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
          body_path: release_body.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}