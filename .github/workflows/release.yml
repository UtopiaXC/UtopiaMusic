name: release

on:
  workflow_dispatch:
    inputs:
      buildNumber:
        description: "Build Number (Option)"
        required: false
      releaseBody:
        description: "Release notes"
        required: false
  push:
    tags:
      - "v*"

env:
  DEFAULT_BUILD_NAME: "0.0.0"
  FLUTTER_CHANNEL: "stable"

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      BUILD_NAME: ${{ steps.ver.outputs.build_name }}
      BUILD_NUMBER: ${{ steps.ver.outputs.build_number }}
      VERSION: ${{ steps.ver.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - name: Compute version
        id: ver
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          build_name=""
          if [ -d assets/documentations/release_note ]; then
            build_name=$(find assets/documentations/release_note -maxdepth 1 -type f -printf '%f\n' | head -n1)
            build_name=${build_name%.*}
          fi
          if [ -z "$build_name" ]; then
            build_name="${DEFAULT_BUILD_NAME}"
          fi

          if [ -n "${{ github.event.inputs.buildNumber }}" ]; then
            bn="${{ github.event.inputs.buildNumber }}"
          else
            TODAY=$(TZ=Asia/Tokyo date +%Y%m%d)
            releases=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/${{ github.repository }}/releases?per_page=100")
            today_count=$(echo "$releases" | jq "[.[] | select(.created_at | fromdate | strftime(\"%Y%m%d\") == \"$TODAY\")] | length")
            seq=$((today_count + 1))
            bn=$(printf "%s%02d" "$TODAY" "$seq")
          fi

          echo "build_name=$build_name" >> "$GITHUB_OUTPUT"
          echo "build_number=$bn" >> "$GITHUB_OUTPUT"
          echo "version=${build_name}+$bn" >> "$GITHUB_OUTPUT"

  android:
    needs: version
    runs-on: ubuntu-latest
    env:
      BUILD_NAME: ${{ needs.version.outputs.BUILD_NAME }}
      BUILD_NUMBER: ${{ needs.version.outputs.BUILD_NUMBER }}
      VERSION: ${{ needs.version.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
      - uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ~/.gradle
            ~/.android
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
      - name: Flutter pub get
        run: flutter pub get
      - name: Build split-per-abi APKs
        run: flutter build apk --release --split-per-abi --build-name $BUILD_NAME --build-number $BUILD_NUMBER
      - name: Collect APKs
        run: |
          mkdir -p out
          for apk in build/app/outputs/flutter-apk/*-release.apk; do
            abi=$(basename "$apk" | sed 's/.*-\(.*\)-release\.apk/\1/')
            cp "$apk" "out/UtopiaMusic_${VERSION}_Android_${abi}.apk"
          done
      - uses: actions/upload-artifact@v4
        with:
          name: android
          path: out/*.apk

  linux:
    needs: version
    runs-on: ubuntu-latest
    env:
      BUILD_NAME: ${{ needs.version.outputs.BUILD_NAME }}
      BUILD_NUMBER: ${{ needs.version.outputs.BUILD_NUMBER }}
      VERSION: ${{ needs.version.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
      - uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libglib2.0-dev patchelf ruby-dev rubygems rpm
          sudo gem install --no-document fpm
          wget -q https://github.com/AppImage/AppImageKit/releases/download/13/appimagetool-x86_64.AppImage -O appimagetool
          chmod +x appimagetool
      - name: Flutter pub get
        run: flutter pub get
      - name: Build linux bundle
        run: flutter build linux --release --build-name $BUILD_NAME --build-number $BUILD_NUMBER
      - name: Package AppImage / deb / rpm
        run: |
          mkdir -p dist/AppDir/usr/bin dist/AppDir/usr/share/applications dist/AppDir/usr/share/icons/hicolor/256x256/apps
          cp -r build/linux/x64/release/bundle/* dist/AppDir/usr/bin/
          cat > dist/AppDir/usr/share/applications/utopiamusic.desktop <<'EOF'
          [Desktop Entry]
          Type=Application
          Name=UtopiaMusic
          Exec=UtopiaMusic
          Icon=utopiamusic
          Categories=Audio;Music;
          EOF
          # use an existing png as icon if available
          if [ -f assets/images/ic_windows.png ]; then cp assets/images/ic_windows.png dist/AppDir/usr/share/icons/hicolor/256x256/apps/utopiamusic.png; fi
          (cd dist && ARCH=x86_64 ../appimagetool AppDir "UtopiaMusic_${VERSION}_Linux_x64.AppImage")
          DEB_VER=${VERSION/+/-}
          fpm -s dir -t deb -n utopiamusic -v "$DEB_VER" --architecture amd64 --prefix /opt/utopiamusic -C build/linux/x64/release/bundle .
          mv utopiamusic_${DEB_VER}_amd64.deb "UtopiaMusic_${VERSION}_Linux_x64.deb"
          RPM_VER=${VERSION/+/.}
          fpm -s dir -t rpm -n utopiamusic -v "$RPM_VER" --architecture x86_64 --prefix /opt/utopiamusic -C build/linux/x64/release/bundle .
          mv utopiamusic-${RPM_VER}-1.x86_64.rpm "UtopiaMusic_${VERSION}_Linux_x64.rpm"
      - uses: actions/upload-artifact@v4
        with:
          name: linux
          path: |
            dist/UtopiaMusic_${{ env.VERSION }}_Linux_x64.AppImage
            dist/UtopiaMusic_${{ env.VERSION }}_Linux_x64.deb
            dist/UtopiaMusic_${{ env.VERSION }}_Linux_x64.rpm

  apple:
    needs: version
    runs-on: macos-latest
    env:
      BUILD_NAME: ${{ needs.version.outputs.BUILD_NAME }}
      BUILD_NUMBER: ${{ needs.version.outputs.BUILD_NUMBER }}
      VERSION: ${{ needs.version.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
      - name: Flutter pub get
        run: flutter pub get
      - name: Build iOS (no codesign by default)
        run: flutter build ios --release --no-codesign --build-name $BUILD_NAME --build-number $BUILD_NUMBER
      - name: Create unsigned IPA
        run: |
          mkdir -p out/ios/Payload
          cp -R build/ios/Release-iphoneos/Runner.app out/ios/Payload/Runner.app
          (cd out/ios && zip -r "UtopiaMusic_${VERSION}_iOS_universal.ipa" Payload)
      - name: Build macOS app
        run: flutter build macos --release --build-name $BUILD_NAME --build-number $BUILD_NUMBER
      - name: Create DMG
        run: |
          mkdir -p out/mac
          APP_PATH=$(find build/macos/Build/Products/Release -maxdepth 1 -name "*.app" | head -n1)
          if [ -z "$APP_PATH" ]; then
            echo "No .app found under build/macos/Build/Products/Release" >&2
            ls -la build/macos/Build/Products/Release || true
            exit 1
          fi
          hdiutil create -volname "UtopiaMusic" -srcfolder "$APP_PATH" -ov -format UDZO "out/mac/UtopiaMusic_${VERSION}_macOS_universal.dmg"
      - uses: actions/upload-artifact@v4
        with:
          name: apple
          path: |
            out/ios/UtopiaMusic_${{ env.VERSION }}_iOS_universal.ipa
            out/mac/UtopiaMusic_${{ env.VERSION }}_macOS_universal.dmg

  windows:
    needs: version
    runs-on: windows-latest
    env:
      BUILD_NAME: ${{ needs.version.outputs.BUILD_NAME }}
      BUILD_NUMBER: ${{ needs.version.outputs.BUILD_NUMBER }}
      VERSION: ${{ needs.version.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
      - name: Flutter pub get
        run: flutter pub get
      - name: Build Windows
        run: flutter build windows --release --build-name $env:BUILD_NAME --build-number $env:BUILD_NUMBER
      - name: Package portable zip
        run: |
          New-Item -ItemType Directory -Force -Path out | Out-Null
          Compress-Archive -Path build\windows\x64\runner\Release\* -DestinationPath "out\UtopiaMusic_${env:VERSION}_Windows_x64_portable.zip"
      - name: Package setup exe (Inno Setup if windows\\installer.iss exists)
        run: |
          if (Test-Path "windows\installer.iss") {
            choco install innosetup -y
            iscc "windows\installer.iss" /DAppVersion=${env:VERSION} /O"out" /F"UtopiaMusic_${env:VERSION}_Windows_x64_setup"
          } else {
            Write-Host "installer.iss not found, skipping setup exe"
          }
      - name: Package MSI (WiX if windows\\installer.wxs exists)
        run: |
          if (Test-Path "windows\installer.wxs") {
            choco install wixtoolset -y
            & 'C:\Program Files (x86)\WiX Toolset v3.11\bin\candle.exe' windows\installer.wxs -dVersion=${env:VERSION} -out installer.wixobj
            & 'C:\Program Files (x86)\WiX Toolset v3.11\bin\light.exe' installer.wixobj -o "out\UtopiaMusic_${env:VERSION}_Windows_x64_msi.msi"
          } else {
            Write-Host "installer.wxs not found, skipping msi"
          }
      - uses: actions/upload-artifact@v4
        with:
          name: windows
          path: out/*

  publish:
    needs: [version, android, linux, apple, windows]
    runs-on: ubuntu-latest
    env:
      BUILD_NAME: ${{ needs.version.outputs.BUILD_NAME }}
      RELEASE_BODY: ${{ github.event.inputs.releaseBody || '' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Prepare release body
        run: |
          note_file="assets/documentations/release_note/${BUILD_NAME}"
          if [ -f "$note_file" ]; then
            cp "$note_file" /tmp/release_body.md
          else
            printf "%s" "$RELEASE_BODY" > /tmp/release_body.md
          fi
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*
          draft: false
          prerelease: false
          body_path: /tmp/release_body.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
